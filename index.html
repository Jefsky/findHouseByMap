<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body,
        html,
        #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=wjugk4K7tYpHO6RUQyzZBMKx3DPUcmVM"></script>
    <title>地图找房</title>
</head>

<body>
    <div id="allmap"></div>
</body>

</html>
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">
    // 百度地图API功能  wjugk4K7tYpHO6RUQyzZBMKx3DPUcmVM
    // $.getJSON('data-area.json', function(data) {
    //     console.log(data);
    // });

    var map = new BMap.Map("allmap");
    var point = new BMap.Point(113.720287, 23.020079);
    map.enableScrollWheelZoom(); //启用滚轮放大缩小，默认禁用
    map.enableContinuousZoom(); //启用地图惯性拖拽，默认禁用
    map.centerAndZoom(point, 12);
    var geolocation = new BMap.Geolocation(); //返回用户当前的位置
    geolocation.getCurrentPosition(function(e) {
        console.log(e)
    })


    // 定义构造函数并继承Overlay
    function CustomOverlay(center, name, text) {
        this._center = center;
        this._name = name;
        this._text = text;
    }

    // 继承API BMap.Overlay
    CustomOverlay.prototype = new BMap.Overlay();

    // 初始化自定义覆盖物
    CustomOverlay.prototype.initialize = function(map) {
        // 保存map对象实例
        this._map = map;
        // 创建div元素，作为自定义覆盖物的容器
        var div = document.createElement("div");
        div.style.position = 'absolute';
        // 根据参数设置元素外观
        div.style.background = "red";
        div.style.MozUserSelect = 'none';
        div.style.borderRadius = "100%";
        div.style.height = '74px';
        div.style.width = '74px';

        var sonDiv = document.createElement("div");
        $(sonDiv).css({
            "height": "74px",
            "width": "74px"
        });
        $(sonDiv).append('<a style="height:74px;width:74px;display:block;font-size:12px;color:#fff;text-align:center;line-height:18px;margin-top:8px;">' + this._name + this._text + '</a>')

        div.appendChild(sonDiv);
        $(div).mousemove(function() {
            $(this).css("z-index", "999999");
            $(this).css("background", "green");
        });
        $(div).mouseout(function() {
            $(this).css("background", "red");
        });

        // 将div添加到覆盖物容器中
        map.getPanes().markerPane.appendChild(div);
        // 保存div实例
        this._div = div;
        // 需要将div元素作为方法的返回值，当调用该覆盖物的show、
        // hide方法，或者对覆盖物进行移除时，API都将操作此元素
        return div;
    }

    // 绘制覆盖物
    CustomOverlay.prototype.draw = function() {
        // 根据地理坐标转换为像素坐标，并设置给容器
        var position = this._map.pointToOverlayPixel(this._center);
        this._div.style.left = position.x - 10 + 'px';
        this._div.style.top = position.y - 10 + 'px';
    }

    // 实现显示方法
    CustomOverlay.prototype.show = function() {
        if (this._div) {
            this._div.style.display = '';
        }
    }

    // 实现隐藏方法
    CustomOverlay.prototype.hide = function() {
        if (this._div) {
            this._div.style.display = 'none';
        }
    }


    function buildBaiduMap(result) {
        // 创建Map实例
        var pointArray = [];
        for (var i = 0; i < result.loupan.hit.length; i++) {
            var sub = result.loupan.hit[i];
            var longitude = sub['x'];
            var latitude = sub['y'];
            var name = sub['projname'];
            var text = '<br>' + sub['price'] + '元/㎡<br>' + sub['tao'] + '套';
            var point = new BMap.Point(longitude, latitude);
            var marker = new CustomOverlay(point, name, text);
            pointArray.push(point);
            map.addOverlay(marker);
        }
        //让所有点在视野范围内
        // map.setViewport(pointArray);
    }

    $(function() {

    })
    $(document).on('mousewheel DOMMouseScroll', onMouseScroll);


    function onMouseScroll() {
        var zoom = map.getZoom();
        console.log(zoom)
        switch (zoom) {
            case 10:
            case 11:
            case 12:
                map.clearOverlays();
                $.getJSON('data-town.json', function(data) {
                    buildBaiduMap(data);
                    console.log('town')
                });
                break;
            case 13:
            case 14:
                map.clearOverlays();
                $.getJSON('data-area.json', function(data) {
                    buildBaiduMap(data);
                    console.log('area')
                });
                break;
            case 15:
            case 16:
                map.clearOverlays();
                $.getJSON('data-estate.json', function(data) {
                    buildBaiduMap(data);
                    console.log('area')
                });
                break;
        }
    }
</script>